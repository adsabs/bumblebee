<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <base href="/" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,user-scalable=no" />
    <meta name="google-site-verification" content="XxQuw38lagr8-TgtCyhAMP_6ELS9dy35fgrqo9dxw3o" />
    <title>Astrophysics Data System</title>
    <meta name="description" content="A powerful, streamlined new Astrophysics Data System" />
    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="./styles/favicon/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="./styles/favicon/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="./styles/favicon/favicon-16x16.png" />
    <link rel="manifest" href="./styles/favicon/site.webmanifest" />
    <link rel="mask-icon" href="./styles/favicon/safari-pinned-tab.svg" color="#5bbad5" />
    <meta name="apple-mobile-web-app-title" content="Astrophysics Data System" />
    <meta name="application-name" content="Astrophysics Data System" />
    <meta name="msapplication-TileColor" content="#ffc40d" />
    <meta name="theme-color" content="#ffffff" />
    <!-- /favicon -->
    <link rel="preload" href="./styles/css/styles.css?v=<APP_VERSION>" as="style" />
    <link rel="preload" href="./libs/require.js" as="script" />
    <link rel="preload" href="config/init.js?v=<APP_VERSION>" as="script" />
    <link rel="stylesheet" href="./styles/css/styles.css?v=<APP_VERSION>" />

    <link
      rel="search"
      type="application/opensearchdescription+xml"
      href="https://ui.adsabs.harvard.edu/config/opensearch.xml"
      title="ADS Search"
    />
    <noscript>
      <style>
        #app-container {
          display: none;
        }

        body {
          overflow: hidden;
          position: absolute;
          width: 100%;
          height: 100%;
          display: flex;
          justify-content: center;
          align-items: center;
        }

        #noscriptmsg {
          max-width: 450px;
          padding: 10px;
        }
      </style>
    </noscript>
    <script src="https://www.google.com/recaptcha/api.js?render=6LcpTuUnAAAAAD6YCBdr_2-0b1AH8N6nXkYEG5G5"></script>
    <!-- Google Tag Manager -->
    <script>
      (function(w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({
          'gtm.start': new Date().getTime(),
          event: 'gtm.js',
        });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != 'dataLayer' ? '&l=' + l : '';
        j.async = true;
        j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, 'script', 'dataLayer', 'GTM-NT2453N');
    </script>
    <!-- End Google Tag Manager -->
  </head>

  <body>
    <noscript>
      <div id="noscriptmsg">
        <p>
          Sorry, but the fully featured ADS requires JavaScript to be enabled.
        </p>
        <p>
          <a class="btn btn-primary" href="https://ui.adsabs.harvard.edu/core">Click here to switch to Basic HTML</a>
        </p>
      </div>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-NT2453N"
        height="0"
        width="0"
        style="display:none;visibility:hidden"
      ></iframe>
    </noscript>

    <!--items for announcement of new page, and optional skip to main content link go here (inserted by master.js)-->

    <div id="app-container">
      <!--this is where bbb discovery gets inserted -->
      <div id="body-template-container" role="main">
        <article class="loading-screen" style="display: none">
          <h1 id="loading-screen-title">
            <span class="logo__astrophysics">astrophysics</span>
            <span class="logo__data-system">data system</span>
          </h1>
          <section id="loading-screen-bar">
            <span class="sr-only">loading...</span>
            <div class="progress">
              <div
                class="progress-bar progress-bar-striped active"
                role="progressbar"
                id="loading-screen-progress"
                aria-valuenow="0"
                aria-valuemin="0"
                aria-valuemax="100"
                style="width: 0%"
              >
                <span class="sr-only">0% Complete</span>
                <span id="loading-screen-message"></span>
              </div>
            </div>
          </section>
          <h3 id="basic-html-message">
            Loading ADS |
            <a href="https://ui.adsabs.harvard.edu/core">Click here to switch to Basic HTML</a>
            (for slow connections/low resources)
          </h3>
          <div class="hidden well-sm center-block" id="app-error-container" data-testid="app-error">
            <div class="alert alert-warning small">
              <span id="app-error-message"></span>
            </div>
          </div>
        </article>
      </div>
    </div>
    <div id="darkSwitch" class="darkmode-toggle" title="Turn on dark mode">
      ðŸŒ“
    </div>
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "WebSite",
        "name": "ADS",
        "url": "https://ui.absads.harvard.edu/",
        "alternateName": "Astrophysics Data System",
        "potentialAction": {
          "@type": "SearchAction",
          "target": "https://ui.adsabs.harvard.edu/search/q={search_term_string}",
          "query-input": "required name=search_term_string"
        }
      }
    </script>
    <script>
      // Progress Bar
      (function() {
        var loadingContainer = document.querySelector('.loading-screen');
        var progressBar = document.getElementById('loading-screen-progress');
        var message = document.getElementById('loading-screen-message');
        var progressInner = document.querySelector('#loading-screen-progress>span');
        var progressValue = 0;

        // show nothing for the first 3 seconds
        setTimeout(function() {
          loadingContainer.setAttribute('style', '');
        }, 3000);

        /**
         *
         */
        window.__setAppLoadingProgress = function(val, msg) {
          if (typeof val === 'function') {
            const newVal = val(progressValue);
            if (typeof newVal === 'number') {
              return window.__setAppLoadingProgress(newVal, msg);
            }
          }

          if (val < progressValue) return;
          try {
            progressBar.setAttribute('aria-valuenow', val);
            progressBar.style = 'width: ' + val + '%';
            progressInner.innerText = val + '% Complete';
            message.innerHTML = msg ? msg : message.innerHTML;
            progressValue = val;
          } catch (e) {
            // do nothing
          }
        };
        setTimeout(__setAppLoadingProgress, 200, 20);
        setTimeout(__setAppLoadingProgress, 500, 25);
        window.__setAppLoadingProgress(15, 'Downloading Assets');
        window.__PAGE_LOAD_TIMESTAMP = new Date();
      })();
    </script>

    <script>

      /**
       * Function to tag spans with specific descriptions based on URL parameters.
       * @param span
       */
      const tagSpans = (span) => {
        if (!span || !span.data || !span.data['http.url']) {
          return span;
        }
        const url = new URL(span.data['http.url']);
        const params = new URLSearchParams(url.search);

        // Prefer explicit ui_tag param, then tag, for stable grouping
        const uiTag = params.get('ui_tag') || params.get('tag');
        if (uiTag) {
          const tag = uiTag;
          // stable, human-friendly span name
          span.description = tag;
          // attach the tag to span data for additional filtering
          span.data['feature.ui_tag'] = tag;
          return span;
        }

        // check for search (left-side) facets
        if (params.has('facet') && params.get('facet') === 'true') {
          if (params.has('facet.field')) {
            span.description = `${params.get('facet.field')} facet`;
          }

          // check for years graph
          if (params.has('facet.pivot')) {
            const pivot = params.get('facet.pivot');
            if (pivot === 'property,year') {
              span.description = 'years graph';
            }
          }
        }
        if (params.has('stats') && params.get('stats') === 'true') {
          if (params.has('stats.field')) {
            const field = params.get('stats.field');

            // check for citations graph
            if (field === 'citation_count') {
              span.description = 'citations graph';
            }

            // check for reads graph
            if (field === 'read_count') {
              span.description = 'reads graph';
            }
          }
        }

        return span;
      };

      // Simulate a process.env-like environment
      window.process = { env: { NODE_ENV: window.ENV ?? 'production' } };

      /*
       * SENTRY REPLAY OPTIMIZATION FOR HIGH-TRAFFIC SITES
       * 
       * This configuration is designed to drastically reduce replay usage while
       * still capturing valuable debugging information:
       * 
       * 1. NO random session recording (replaysSessionSampleRate: 0)
       * 2. Smart error-based sampling with daily quotas
       * 3. Filtered out common/expected errors that don't need replays
       * 4. Higher priority for critical JavaScript errors
       * 5. Reduced payload sizes by blocking media and limiting network capture
       * 6. Daily quota limits (100 replays/day in prod, 1000 in dev)
       * 
       * Expected impact: ~99.9% reduction in replay usage
       */

      // Modern helper for accessing Sentry
      const withSentry = function (callback) {
        if (typeof window.Sentry !== 'undefined') {
          try {
            callback(window.Sentry);
          } catch (e) {
            // Silently handle errors in callback
          }
        }
      };

      // Legacy compatibility helpers for smooth transition
      window.whenSentryReady = function() {
        return new Promise((resolve) => {
          if (typeof window.Sentry !== 'undefined') {
            resolve(window.Sentry);
          } else {
            // If Sentry isn't loaded yet, wait for it
            const checkSentry = () => {
              if (typeof window.Sentry !== 'undefined') {
                resolve(window.Sentry);
              } else {
                setTimeout(checkSentry, 50);
              }
            };
            checkSentry();
          }
        });
      };

      window.getSentry = function(callback, errorCallback = () => {}) {
        if (typeof window.Sentry !== 'undefined') {
          try {
            callback(window.Sentry);
          } catch (e) {
            errorCallback(e);
          }
        } else {
          // If Sentry isn't loaded yet, wait for it
          const checkSentry = () => {
            if (typeof window.Sentry !== 'undefined') {
              try {
                callback(window.Sentry);
              } catch (e) {
                errorCallback(e);
              }
            } else {
              setTimeout(checkSentry, 50);
            }
          };
          checkSentry();
        }
      };

      // Daily quota management for replays
      function checkDailyReplayQuota() {
        const today = new Date().toDateString();
        const quotaKey = 'sentry_replay_quota';
        const dateKey = 'sentry_replay_date';
        
        try {
          const savedDate = localStorage.getItem(dateKey);
          let replayCount = parseInt(localStorage.getItem(quotaKey) || '0');
          
          // Reset quota if it's a new day
          if (savedDate !== today) {
            replayCount = 0;
            localStorage.setItem(dateKey, today);
          }
          
          // Daily limit: 100 replays max (adjust as needed)
          const DAILY_LIMIT = window.ENV === 'development' ? 1000 : 100;
          
          if (replayCount >= DAILY_LIMIT) {
            return false;
          }
          
          // Increment counter
          localStorage.setItem(quotaKey, (replayCount + 1).toString());
          return true;
          
        } catch (e) {
          // If localStorage fails, still allow some replays but be more restrictive
          return Math.random() < 0.0001; // 0.01%
        }
      }

      // Smart replay sampling based on actual project error patterns
      function shouldCaptureReplay(errorEvent) {
        // Always capture in development (but still respect quota)
        if (window.ENV === 'development') {
          return checkDailyReplayQuota();
        }
        
        // Check daily quota first
        if (!checkDailyReplayQuota()) {
          return false;
        }
        
        const errorMessage = errorEvent?.message || errorEvent?.exception?.values?.[0]?.value || '';
        const errorType = errorEvent?.exception?.values?.[0]?.type || '';
        const stacktrace = errorEvent?.exception?.values?.[0]?.stacktrace?.frames || [];
        const filename = stacktrace[0]?.filename || '';
        
        // HIGH-VOLUME ERROR PATTERNS FROM PROJECT DATA (BUMBLEBEE issues)
        // These patterns are consuming most of your replay quota
        const highVolumeFilters = [
          // BUMBLEBEE-1TC: 172k events - Syntax errors from invalid tokens
          /Invalid or unexpected token/i,
          /SyntaxError.*Invalid.*token/i,
          /Unexpected token/i,
          
          // BUMBLEBEE-D: 13k events - RequireJS script loading
          /Script error for.*js\//i,
          /RequireJS.*scripterror/i,
          /Mismatched anonymous define/i,
          /needed by: router/i,
          
          // BUMBLEBEE-7QW/7QV: 6.8k events - Google Tag Manager
          /window\.__tcfapi is not a function/i,
          /gtag.*not.*function/i,
          /ga.*not.*function/i,
          /_gaCustomDimensionUserType.*not defined/i,
          
          // BUMBLEBEE-5KN: 2.6k events - Google Analytics loading
          /window\.ga.*appear/i,
          /gtag.*does not appear to load/i,
          /Maximum.*retries.*window\.ga/i,
          
          // Multiple jQuery/Bootstrap issues: ~5k events combined
          /jQuery.*not defined/i,
          /\$.*not defined/i,
          /Bootstrap.*requires jQuery/i,
          
          // Multiple "Failed to fetch" issues: ~2k events combined  
          /Failed to fetch/i,
          /TypeError.*fetch/i,
          /Network request failed/i,
          
          // BUMBLEBEE-45X: 3k events - Empty values
          /Empty values not allowed/i,
          
          // BUMBLEBEE-75Y: 3.3k events - Search failures (rate limiting)
          /Search cycle failed to start/i,
          
          // Multiple "Cannot read properties" errors: ~2k events
          /Cannot read properties of undefined/i,
          /Cannot read properties of null/i,
          
          // Third-party script errors
          /pintrk.*not defined/i,
          /vbpx.*not defined/i,
          /efDataLayer.*not defined/i,
          /webVitals.*not defined/i,
          
          // Performance/Asset issues (BUMBLEBEE-1R2: 7.5k events)
          /Uncompressed Asset/i,
          /Large.*payload/i,
          /Large Render Blocking Asset/i,
          
          // Common framework noise
          /ResizeObserver loop limit exceeded/i,
          /Non-Error promise rejection/i,
          /ChunkLoadError/i,
          /Loading chunk.*failed/i,
          /Script error/i,
          /Maximum call stack size exceeded/i,
          
          // Cross-origin and security errors
          /Blocked.*from.*cross-origin/i,
          /SecurityError.*cross-origin/i,
          /Blocked 'connect'/i,
          /Blocked 'script'/i,
          /Blocked 'font'/i
        ];
        
        // Third-party domains that generate noise
        const thirdPartyFilenames = [
          /googletagmanager\.com/i,
          /google-analytics\.com/i,
          /gtm\.js/i,
          /analytics\.js/i,
          /pinterest\.com/i,
          /cubox\.pro/i,
          /sentry\.io/i,
          /cloudflare\.com/i,
          /cdn\./i
        ];
        
        // Filter out high-volume, low-value errors
        const isHighVolumeError = highVolumeFilters.some(pattern => 
          pattern.test(errorMessage) || pattern.test(errorType)
        );
        
        const isThirdPartyError = thirdPartyFilenames.some(pattern => 
          pattern.test(filename)
        );
        
        // Don't capture replays for filtered errors
        if (isHighVolumeError || isThirdPartyError) {
          return false;
        }
        
        // For remaining errors, sample at very low rates
        // These should be genuinely critical application errors
        const criticalErrors = [
          /ViewDestroyedError/i, // Framework errors
          /getBeeHive.*getService.*not a function/i, // App-specific errors
          /Services\.get.*not a function/i // App-specific errors
        ];
        
        const isAppCritical = criticalErrors.some(pattern => 
          pattern.test(errorMessage) || pattern.test(errorType)
        );
        
        // Very conservative sampling even for critical errors
        const sampleRate = isAppCritical ? 0.05 : 0.001; // 5% vs 0.1%
        return Math.random() < sampleRate;
      }

      // Initialize Sentry after the script loads
      function initSentry() {
        if (typeof Sentry !== 'undefined') {
          Sentry.init({
            dsn: 'https://46062cbe0aeb7a3b2bb4c3a9b8cd1ac7@o1060269.ingest.us.sentry.io/4507341192036352',
            tracesSampleRate: window.ENV === 'development' ? 1.0 : 0.75,
            debug: false,
            enableLogs: true,
            _experiments: {
              enableStandaloneLcpSpans: true,
              enableStandaloneClsSpans: true,
            },
            allowUrls: [
              /https:\/\/.*\.adsabs\.harvard\.edu\/.*/,
              /https:\/\/code\.jquery\.com\/.*/,
              /https:\/\/cdn\.jsdelivr\.net\/.*/,
            ],
            // Aggressive replay reduction for high-traffic sites
            replaysSessionSampleRate: 0, // No random session recording
            replaysOnErrorSampleRate: 0, // Disabled - we'll use beforeSend logic instead
            environment: window.ENV ?? 'production',
            integrations: [
              Sentry.browserTracingIntegration(),
              Sentry.replayIntegration({
                // Privacy and size optimizations
                maskAllText: false, // Keep text visible for debugging
                blockAllMedia: true, // Block images/videos to reduce payload
                blockClass: 'sentry-block', // CSS class to block elements
                ignoreClass: 'sentry-ignore', // CSS class to ignore elements
                unmask: ['[name=q]', '.search-field', '.query-input'], // Keep search inputs visible
                
                // Aggressive network filtering - only capture critical API calls
                networkDetailAllowUrls: [
                  /\/api\/v1\//,              // Core API calls
                  /\/search\/query/,          // Search queries  
                  /\/resolver\//,             // Citation resolver
                  /\/export\//,               // Export functionality
                  /\/user\//,                 // User management
                  /\/myads\//                 // User libraries
                ],
                
                // Minimize network data capture
                networkCaptureBodies: false,       // No request/response bodies
                networkRequestHeaders: [],         // No request headers  
                networkResponseHeaders: [],        // No response headers
                
                // Performance optimizations
                maxReplayDuration: 300000,         // 5 minutes max replay length
                sessionSampleRate: 0,              // No automatic sessions
                errorSampleRate: 0,                // We handle this in beforeSend
                
                // Additional payload reduction
                recordCanvas: false,               // Don't record canvas elements
                collectFonts: false,               // Don't capture font loads
                inlineStylesheet: false,           // Don't inline stylesheets
                inlineImages: false,               // Don't inline images
                
                // Only capture minimal DOM mutations
                mutationBreadcrumbLimit: 750,      // Reduce mutation tracking
                mutationLimit: 10000,              // Limit DOM mutations captured
              }),
            ],
            beforeSend(event, hint) {
              // Smart replay capture logic
              if (hint.originalException && shouldCaptureReplay(event)) {
                // Only start replay for this specific error
                if (window.Sentry && typeof window.Sentry.getReplay === 'function') {
                  const replay = window.Sentry.getReplay();
                  if (replay && !replay.isEnabled()) {
                    replay.start();
                  }
                }
              }
              return event;
            },
            beforeSendSpan: tagSpans
          });
        }
      }

      
    </script>

    <script
      src="https://browser.sentry-cdn.com/10.21.0/bundle.tracing.replay.min.js"
      integrity="sha384-qMX/qwnFA+J4Pv2Gnngz4M1WmLwT0ajrVIQgtdyRExx0QSoG9rSiLtydtCdYzhzk"
      crossorigin="anonymous"
      onload="initSentry()"
    ></script>

    <!-- start the discovery application -->
    <script src="./libs/require.js"></script>
    <script src="config/init.js?v=<APP_VERSION>"></script>
  </body>
</html>
