daemon off;

worker_processes auto;

worker_rlimit_nofile 10000;

user nobody nogroup;

pid /tmp/nginx.pid;

events {
    worker_connections 2048;
    accept_mutex off; # "on" if nginx worker_processes > 1
    use epoll;
}


http{

    log_format main escape=json '{"remote_addr": "$remote_addr","X-Original-Forwarded-For": "$proxy_add_x_forwarded_for","X-Forwarded-For": "$remote_user","time_local": "$time_local", "time_iso8601": "$time_iso8601", "msec": "$msec", "request": "$request","status": "$status","body_bytes_sent": "$body_bytes_sent","http_referer": "$http_referer","http_user_agent": "$http_user_agent","request_length": "$request_length","Authorization": "$http_Authorization","url-path": "$document_uri","query-string": "$query_string","X-Original-Uri": "$request_uri" ,"http_cookie": "$http_cookie","X-Amzn-Trace-Id": "$http_x_amzn_trace_id"}';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log;

    upstream adsclassic {
        server adsabs.harvard.edu;
        keepalive 32;
    }

    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        server_name _;

        location /ready {
            access_log off;
            return 200 "{\"ready\": true}";
        }
        location /alive {
            access_log off;
            return 200 "{\"alive\": true}";
        }

        location /index.html {
            proxy_pass https://s3.amazonaws.com/static.adsabs.harvard.edu/index.html;
        }
        location /robots.txt {
            proxy_pass https://s3.amazonaws.com/static.adsabs.harvard.edu/robots.txt;
        }
        location ~ ^/sitemap/(.*)$ {
            proxy_pass https://s3.amazonaws.com/static.adsabs.harvard.edu/sitemap/$1;
        }
        location /static/ {
            proxy_pass http://static.adsabs.harvard.edu.s3-website-us-east-1.amazonaws.com;
        }
        location /cgi-bin/ {
            proxy_pass http://adsclassic;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            sub_filter "http://adsabs.harvard.edu/" "/";
            sub_filter_once off;
        }
        location /abs/ {
            proxy_pass http://adsabs0.cfa.harvard.edu;
            sub_filter "http://adsabs.harvard.edu/" "/";
            sub_filter_once off;
        }

        location /help/ {
            proxy_pass http://adsabs.github.io;
        }
        location /blog/ {
            proxy_pass http://adsabs.github.io;
        }
        location /about/ {
            proxy_pass http://adsabs.github.io;
        }
        location /analytics/ {
            proxy_pass http://127.0.0.1:8082;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        access_log  off;
    }

    server {
        listen 80;
        listen [::]:80;

        server_name pipeline-kibana.kube.adslabs.org;
        auth_basic      "these aren't the droids you're looking for";
        auth_basic_user_file /htpasswd;
        
        resolver 192.168.0.1 ;
        set $upstream_endpoint https://search-pipeline-d6gsitdlgp2dh25slmlrcwjtse.us-east-1.es.amazonaws.com;
        location / {
            proxy_pass $upstream_endpoint;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Authorization "";
        }

    }

    server {
            listen 80;
            listen [::]:80;

            server_name solr-kibana.kube.adslabs.org;
            auth_basic      "these aren't the droids you're looking for";
            auth_basic_user_file /htpasswd;

            resolver 192.168.0.1 ;
            set $upstream_endpoint https://search-solr-6mswtaciusvc4pf4okhnsduj2m.us-east-1.es.amazonaws.com;
            location / {
                proxy_pass $upstream_endpoint;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_set_header Authorization "";
            }

    }

    server {
            listen 80;
            listen [::]:80;

            server_name graylog-kibana.kube.adslabs.org;
            auth_basic      "these aren't the droids you're looking for";
            auth_basic_user_file /htpasswd;

            resolver 192.168.0.1 ;
            set $upstream_endpoint https://vpc-kube-v112-graylog-3fxjjhb7kuzxshumuoeicbwzgq.us-east-1.es.amazonaws.com;
            location / {
                proxy_pass $upstream_endpoint;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_set_header Authorization "";
            }

    }

    server {
            listen 8082;
            listen [::]:8082;

            access_log /var/log/nginx/analytics.access.log;
            error_log /var/log/nginx/analytics.error.log;
            
            resolver 192.168.0.1 ;
            set $upstream_endpoint https://www.google-analytics.com;

            location / {
                proxy_pass $upstream_endpoint;
                
            }

            location /u/d/{
                proxy_set_header Accept-Encoding "";
                sub_filter 'www.google-analytics.com' '"+location.host+"/analytics';
                sub_filter_types *;
                sub_filter_once off;
                proxy_pass $upstream_endpoint/u/d;
                break;
            }


            location /gtm/js/{
                proxy_set_header Accept-Encoding "";
                sub_filter 'www.google-analytics.com' '"+location.host+"/analytics';
                sub_filter_types *;
                sub_filter_once off;
                proxy_pass $upstream_endpoint/gtm/js;
                break;
            }
        
            location /plugins/ua/{
                proxy_set_header Accept-Encoding "";
                sub_filter 'www.google-analytics.com' '"+location.host+"/analytics';
                sub_filter_types *;
                sub_filter_once off;
                proxy_pass $upstream_endpoint/plugins/ua;
                break;
            }

    }


    server {
        listen 8080;
        server_name _;
        return 200;
        access_log  off;
    }
}
