worker_processes auto;
worker_rlimit_nofile 10000;
user nobody nogroup;
pid /tmp/nginx.pid;

events {
    worker_connections 2048;
    accept_mutex off;
    use epoll;
}

http {
  # Gzip compression
  gzip on;
  gzip_disable "msie6";
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_buffers 16 8k;
  gzip_http_version 1.1;
  gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
  gzip_min_length 500;

  # Logging
  log_format minimal_json
    '{'
      '"remote_addr": "$remote_addr",'
      '"x_forwarded_for": "$proxy_add_x_forwarded_for",'
      '"user": "$remote_user",'
      '"time": "$time_local",'
      '"request": "$request",'
      '"status": "$status",'
      '"body_bytes_sent": "$body_bytes_sent",'
      '"referer": "$http_referer",'
      '"user_agent": "$http_user_agent",'
      '"request_length": "$request_length",'
      '"authorization": "$http_authorization",'
      '"url_path": "$document_uri",'
      '"query_string": "$query_string",'
      '"original_uri": "$request_uri",'
      '"x_amzn_trace_id": "$http_x_amzn_trace_id"'
    '}';
  access_log /var/log/nginx/access.log minimal_json;
  error_log /var/log/nginx/error.log debug;

  log_format proxy_debug
    '{'
      '"client_ip": "$remote_addr",'
      '"request": "$request",'
      '"status": "$status",'
      '"proxy_host": "$proxy_host",'
      '"upstream_addr": "$upstream_addr",'
      '"upstream_status": "$upstream_status",'
      '"host": "$host",'
      '"referer": "$http_referer",'
      '"user_agent": "$http_user_agent"'
    '}';

  # âœ… Ensures your config is loaded
  include /etc/nginx/conf.d/*.conf;
}
