daemon off;
worker_processes auto;
worker_rlimit_nofile 10000;
user nobody nogroup;
pid /tmp/nginx.pid;
env DEV_API_URL;
env QA_API_URL;
env PROD_API_URL;

events {
    worker_connections 2048;
    accept_mutex off;
    use epoll;
}

http {
  include /etc/nginx/mime.types;

  ##
  # Gzip Settings
  ##
  gzip on;
  gzip_disable "msie6";
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_buffers 16 8k;
  gzip_http_version 1.1;
  gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

   # DNS + SNI for variable proxy_pass
   resolver 1.1.1.1 9.9.9.9 valid=300s ipv6=off;
   proxy_ssl_server_name on;

   # CORS maps
   map $http_origin $cors_allow_origin {
     default "";
     ~^https?://localhost(:\d+)?$ $http_origin;
   }
   map $cors_allow_origin $cors_allow_credentials {
     default "true";
     "" "false";
   }

   # Declare logging variable
   map "" $full_upstream_url { default ""; }

   # JSON-safe log formats
   log_format main '{\"remote_addr\":\"$remote_addr\",\"time_local\":\"$time_local\",'
                   '\"request\":\"$request\",\"status\":\"$status\",\"body_bytes_sent\":\"$body_bytes_sent\",'
                   '\"http_referer\":\"$http_referer\",\"http_user_agent\":\"$http_user_agent\"}';

   log_format proxylog '{\"remote_addr\":\"$remote_addr\",\"time_local\":\"$time_local\",'
                       '\"request\":\"$request\",\"status\":\"$status\",\"body_bytes_sent\":\"$body_bytes_sent\",'
                       '\"http_referer\":\"$http_referer\",\"http_user_agent\":\"$http_user_agent\",'
                       '\"upstream\":\"$full_upstream_url\"}';

   access_log /var/log/nginx/access.log main;
   error_log  /var/log/nginx/error.log;
   include conf.d/default.conf;
}
